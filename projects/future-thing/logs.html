<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Prompt Logs</title>
	<style>
		body { font-family: system-ui, sans-serif; padding: 2rem; max-width: 1000px; margin: auto; }
		table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
		select { padding: 0.5rem; font-size: 1rem; }
		#log-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
		#log-table th, #log-table td { border: 1px solid #ccc; padding: 8px; vertical-align: top; word-wrap: break-word; }
		#log-table th:nth-child(1),
		#log-table td:nth-child(1) { width: 10%; }
		#log-table th:nth-child(2),
		#log-table td:nth-child(2) { width: 10%; }
		#log-table th:nth-child(3),
		#log-table td:nth-child(3) { width: 40%; }
		#log-table th:nth-child(4),
		#log-table td:nth-child(4) { width: 40%; }
		.prompt-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
		.scenario-wrapper { max-height: 100px; overflow: hidden; position: relative; cursor: pointer; }
		.scenario-wrapper.expanded { max-height: none; }
		.toggle-label { cursor: pointer; font-weight: bold; margin-bottom: 5px; color: #007bff; }
		.toggle-content { display: none; margin-top: 5px; }
		.toggle-content.expanded { display: block; }
		.provocation-tag { background-color: #ffcc00; color: #000; padding: 2px 6px; font-size: 0.8rem; border-radius: 4px; }
	</style>
</head>

<body>
	<h1>Prompt Logs</h1>
	<div class="filters">
		<label for="filter">Filter by time:</label>
			<select id="filter">
				<option value="24h">Last 24 hours</option>
				<option value="week" selected>This week</option>
				<option value="month">This month</option>
				<option value="year">This year</option>
				<option value="all">All of time</option>
			</select>
		<button id="expand-all">Expand all</button>
		<button id="collapse-all">Collapse all</button>
	</div>
		
			
	
	
	<table id="log-table">
		<thead>
			<tr>
				<th>Timestamp</th>
				<th>IP / Location</th>
				<th>Prompt</th>
				<th>Response</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
	
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script>
	const tableBody = document.querySelector("#log-table tbody");
	const filter = document.getElementById("filter");
	const PASSWORD_KEY = "logs_password";
	const PASSWORD_TS_KEY = "logs_password_ts";
	const PASSWORD_TTL = 30 * 60 * 1000; // 30 minutes in ms
	const WORKER_URL = "https://gemini-worker.hakmal.workers.dev";

	// Prompt user for password if missing or expired
	function getPassword() {
	  const storedPassword = localStorage.getItem(PASSWORD_KEY);
	  const storedTs = parseInt(localStorage.getItem(PASSWORD_TS_KEY), 10);
	  const now = Date.now();

	  if (!storedPassword || !storedTs || now - storedTs > PASSWORD_TTL) {
	    const password = prompt("Enter logs password:");
	    if (!password) {
	      alert("Password is required to view logs.");
	      throw new Error("No password entered");
	    }
	    localStorage.setItem(PASSWORD_KEY, password);
	    localStorage.setItem(PASSWORD_TS_KEY, now.toString());
	    return password;
	  }
	  return storedPassword;
	}

	async function loadLogs(range = "week") {
	  tableBody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

	  let password;
	  try {
	    password = getPassword();
	  } catch (err) {
	    tableBody.innerHTML = "<tr><td colspan='4'>Access denied</td></tr>";
	    return;
	  }

	  try {
	    const res = await fetch(`${WORKER_URL}/logs?range=${range}`, {
	      headers: { "x-logs-secret": password }
	    });

	    if (!res.ok) {
	      if (res.status === 403) {
	        // Password wrong, clear and retry
	        localStorage.removeItem(PASSWORD_KEY);
	        localStorage.removeItem(PASSWORD_TS_KEY);
	        alert("Invalid password. Please try again.");
	        return loadLogs(range);
	      }
	      throw new Error(`HTTP ${res.status}`);
	    }

	    const data = await res.json();
	    if (!Array.isArray(data) || data.length === 0) {
	      tableBody.innerHTML = "<tr><td colspan='4'>No entries found.</td></tr>";
	      return;
	    }

	    // Sort newest first
	    data.sort((a, b) => b.timestamp - a.timestamp);
	    tableBody.innerHTML = "";

	    data.forEach(entry => {
	      const row = document.createElement("tr");

	      // Timestamp
	      const tsCell = document.createElement("td");
	      tsCell.textContent = new Date(entry.timestamp).toLocaleString();
	      row.appendChild(tsCell);

	      // IP/location
	      const ipCell = document.createElement("td");
	      ipCell.textContent = `${entry.ip || "unknown"} (${entry.city || "N/A"}, ${entry.country || "N/A"})`;
	      row.appendChild(ipCell);

	      // Prompt
	      const promptCell = document.createElement("td");
	      const promptToggle = document.createElement("div");
	      promptToggle.classList.add("toggle-label");
	      promptToggle.textContent = "Show full prompt ⏵";
	      const promptContent = document.createElement("div");
	      promptContent.classList.add("toggle-content");
	      promptContent.innerHTML = marked.parse(entry.prompt || "");
	      promptToggle.addEventListener("click", () => {
	        const expanded = promptContent.classList.toggle("expanded");
	        promptToggle.textContent = expanded ? "Hide prompt ⏷" : "Show full prompt ⏵";
	      });
	      promptCell.appendChild(promptToggle);
	      promptCell.appendChild(promptContent);
	      row.appendChild(promptCell);

	      // Scenario
	      const scenarioCell = document.createElement("td");
	      const scenarioToggle = document.createElement("div");
	      scenarioToggle.classList.add("toggle-label");
	      scenarioToggle.textContent = "Show full response ⏵";
	      const scenarioContent = document.createElement("div");
	      scenarioContent.classList.add("toggle-content");
	      scenarioContent.innerHTML = marked.parse(entry.scenario || "");
	      scenarioToggle.addEventListener("click", () => {
	        const expanded = scenarioContent.classList.toggle("expanded");
	        scenarioToggle.textContent = expanded ? "Hide response ⏷" : "Show full response ⏵";
	      });
	      scenarioCell.appendChild(scenarioToggle);
	      scenarioCell.appendChild(scenarioContent);
	      row.appendChild(scenarioCell);

	      tableBody.appendChild(row);
	    });

	  } catch (err) {
	    console.error(err);
	    tableBody.innerHTML = "<tr><td colspan='4'>Error loading logs</td></tr>";
	  }
	}

	// Filter change
	filter.addEventListener("change", () => {
	  loadLogs(filter.value);
	});

	// Initial load
	loadLogs();
	</script>
	
	
</body>
</html>